> 参考来源：
> 康师傅：https://www.bilibili.com/video/BV1iq4y1u7vj?p=109
> 爱编程的大李子：https://blog.csdn.net/LXYDSF/article/details/125755327

# 一、Connectors

Connectors指的是不同语言中与SQL的交互。例如：JDBC、.NET、PHP、Python。

# 二、MySQL Server结构

## 第 1 层：连接层

系统(客户端)访问 MySQL 服务器前，做的第一件事就是建立 `TCP` 连接。 经过三次握手建立连接成功后，MySQL 服务器对 `TCP` 传输过来的账号密码做身份认证、权限获取。

TCP 连接收到请求后，必须要分配给一个线程专门与这个客户端的交互。所以还会有个线程池，去走后面的流程。每一个连接从线程池中获取线程，省去了创建和销毁线程的开销。

所以**连接管理的职责是负责认证、管理连接、获取权限信息**。

## 第 2 层：服务层

第二层架构主要完成大多数的核心服务功能，如SQL接口， 并完成缓存的查询，SQL的分析和优化及部分内置函数的执行。所有跨存储引擎的功能也在这一层实现，如过程、函数等。

在该层，服务器会解析查询并创建相应的内部解析树，并对其完成相应的优化：如确定查询表的顺序，是否利用索引等，最后生成相应的执行操作。

### 1. SQL Interface：SQL接口

- 接收用户的 SQL 命令，并且返回用户需要查询的结果。比如 SELECT ... FROM 就是调用 SQL Interface
- MySQL 支持 DML（数据操作语言）、DDL（数据定义语言）、存储过程、视图、触发器、自定义函数等多种 SQL 语言接口

### 2. Parser：解析器

- 在解析器中对 SQL 语句进行语法分析、语义分析。将 SQL 语句分解成数据结构，并将这个结构传递到后续步骤，以后 SQL 语句的传递和处理就是基于这个结构的。如果在分解构成中遇到错误，那么就说明这个 SQL 语句是不合理的。

- 在 SQL 命令传递到解析器的时候会被解析器验证和解析，并为其创建 语法树，并根据数据字典丰富查询语法树，会 验证该客户端是否具有执行该查询的权限 。创建好语法树后，MySQL 还会对 SQL 查询进行语法上的优化，进行查询重写。
  

### 3. Optimizer：查询优化器

- SQL 语句在语法解析之后、查询之前会使用查询优化器确定 SQL 语句的执行路径，生成一个 执行计划 。

- 这个执行计划表明应该 使用哪些索引 进行查询（全表检索还是使用索引检索），表之间的连接顺序如何，最后会按照执行计划中的步骤调用存储引擎提供的方法来真正的执行查询，并将查询结果返回给用户。
  

### 4. Caches & Buffers: 查询缓存组件

- MySQL内部维持着一些 Cache 和 Buffer，比如 Query Cache 用来缓存一条 SELECT 语句的执行结果，如果能够在其中找到对应的查询结果，那么就不必再进行查询解析、优化和执行的整个过程了，直接将结果反馈给客户端。

- 这个缓存机制是由一系列小缓存组成的。比如表缓存，记录缓存，key缓存，权限缓存等 。

- 这个查询缓存可以在 **不同客户端之间共享** 。

- 从 MySQL 5.7.20 开始，不推荐使用查询缓存，**并在 MySQL 8.0中删除** 。
  

## 第 3 层：引擎层

MyISAM、InnoDB ...

和其它数据库相比，MySQL有点与众不同，它的架构可以在多种不同场景中应用并发挥良好作用，主要体现在存储引擎的架构上，插件式的存储引擎架构将查询处理和其它的系统任务以及数据的存储提取相分离。这种架构可以根据业务的需求和实际需要选择合适的存储引擎。同时开源的 MySQL还允许开发人员设置自己的存储引擎。

这种高效的模块化架构为那些希望专门针对特定应用程序需求(例如数据仓库、事务处理或高可用性情况)的人提供了巨大的好处，同时享受使用一组独立于任何接口和服务的优势存储引擎。

插件式存储引擎层（Storage Engines），真正的负责了MySQL中数据的存储和提取，对物理服务器级别维护的底层数据执行操作 ，服务器通过 API 与存储引擎进行通信。不同的存储引擎具有的功能不同，这样我们可以根据自己的实际需要进行选取。

```mysql
# 查询 MySQL 支持的存储引擎
SHOW ENGINES;
```

# 三、存储层

所有的数据，数据库、表的定义，表的每一行的内容，索引，都是存在 文件系统 上，以 文件 的方式存 在的，并完成与存储引擎的交互。当然有些存储引擎比如InnoDB，也支持不使用文件系统直接管理裸设备，但现代文件系统的实现使得这样做没有必要了。在文件系统之下，可以使用本地磁盘，可以使用 DAS、NAS、SAN等各种存储系统。
```mysql
# 查询存储数据库文件的位置
SHOW VARIABLES LIKE '%datadir%';
```

# 四、小结

为了熟悉 SQL 执行流程方便，我们可以简化为三层结构：

1. 连接层：客户端和服务器端建立连接，客户端发送 SQL 至服务器端;
2. SQL 层（服务层）：对 SQL 语句进行查询处理；与数据库文件的存储方式无关;
3. 存储引擎层：与数据库文件打交道，负责数据的存储和读取。